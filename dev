#!/usr/bin/env bash

set -e

# Function to check environment variables
check_env_vars() {
  if [ -z "$POSTGRES_USER" ]; then
    echo "Error: POSTGRES_USER environment variable is not set"
    exit 1
  fi

  if [ -z "$POSTGRES_PASSWORD" ]; then
    echo "Error: POSTGRES_PASSWORD environment variable is not set"
    exit 1
  fi

  if [ -z "$POSTGRES_DB" ]; then
    echo "Error: POSTGRES_DB environment variable is not set"
    exit 1
  fi
}

# Function to start database (without keeping it running)
setup_db() {
  check_env_vars

  echo "Starting PostgreSQL database..."
  docker compose up -d db

  echo "Waiting for PostgreSQL to be ready..."
  until docker compose exec -T db pg_isready -U postgres > /dev/null 2>&1; do
    echo "  Waiting for database..."
    sleep 1
  done

  echo "Database is ready!"

  echo "Running migrations..."
  pushd packages/api/migrate > /dev/null
  go run migrate.go up
  popd > /dev/null
}

# Function to start database and keep running
start_db() {
  setup_db

  echo "Development environment is ready!"
  echo "Press Ctrl+C to stop..."

  # Trap SIGINT and stop the database
  trap 'echo "Stopping database..."; docker compose down; exit 0' INT

  # Keep the script running
  while true; do
    sleep 1
  done
}

# Function to start API
start_api() {
  echo "Starting Go API..."
  pushd packages/api > /dev/null
  go run main.go
  popd > /dev/null
}

# Function to start web app
start_web() {
  echo "Starting Astro web app..."
  pushd packages/web > /dev/null
  npm run dev
  popd > /dev/null
}

# Function to start everything
start_all() {
  check_env_vars

  # Setup database first
  setup_db

  echo "Starting all services..."

  # Start API in background with prefixed output
  pushd packages/api > /dev/null
  (go run main.go 2>&1 | sed 's/^/[api] /') &
  API_PID=$!
  popd > /dev/null

  # Start web in background with prefixed output
  pushd packages/web > /dev/null
  (npm run dev 2>&1 | sed 's/^/[web] /') &
  WEB_PID=$!
  popd > /dev/null

  echo "All services started!"
  echo "Press Ctrl+C to stop all services..."

  # Trap SIGINT and stop everything
  trap 'echo "Stopping all services..."; kill $API_PID $WEB_PID 2>/dev/null; docker compose down; exit 0' INT

  # Keep the script running
  while true; do
    sleep 1
  done
}

# Main script
case "$1" in
  db)
    start_db
    ;;
  api)
    start_api
    ;;
  web)
    start_web
    ;;
  all)
    start_all
    ;;
  *)
    echo "Usage: $0 {db|api|web|all}"
    echo ""
    echo "Commands:"
    echo "  db   - Start PostgreSQL database and run migrations"
    echo "  api  - Start Go API server"
    echo "  web  - Start Astro web development server"
    echo "  all  - Start all services (database, API, and web)"
    exit 1
    ;;
esac
